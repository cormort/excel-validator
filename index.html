<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="SumCheck - 智能 Excel 數值驗算工具，自動檢查合計與小計錯誤"
    />
    <title>SumCheck | Excel 驗算大師</title>

    <!-- Favicon -->
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📊</text></svg>"
    />

    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/variables.css" />
    <link rel="stylesheet" href="css/components.css" />
    <link rel="stylesheet" href="css/components-enhanced.css" />
    <link rel="stylesheet" href="css/visualization.css" />
    <link rel="stylesheet" href="css/main.css" />

    <!-- SheetJS for Excel parsing -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  </head>

  <body>
    <div class="app">
      <!-- Header -->
      <header class="header">
        <div class="header-brand">
          <span class="header-logo">✓</span>
          <h1 class="header-title">SumCheck</h1>
        </div>
        <div class="header-actions">
          <button
            id="themeToggle"
            class="theme-toggle"
            aria-label="切換主題"
          ></button>
        </div>
      </header>

      <!-- Toolbar -->
      <div class="toolbar">
        <!-- 左側：檔案操作 -->
        <div class="toolbar-group">
          <button id="btnLoadFile" class="btn btn-primary">
            <span>📁</span> 載入 Excel
          </button>
          <input
            type="file"
            id="fileInput"
            accept=".xlsx,.xls"
            style="display: none"
          />
          <div class="input-group" id="sheetGroup" style="display: none">
            <select id="sheetSelector" class="select"></select>
          </div>
        </div>

        <!-- 中間：模式選擇 -->
        <div class="toolbar-group">
          <label class="toolbar-label">驗算模式</label>
          <select id="calcMode" class="select select-mode">
            <option value="vertical_group">
              ↕️ 縱向 (關鍵字分組) - 適用預算表
            </option>
            <option value="vertical_indent">
              ↕️ 縱向 (縮排分層) - 適用階層結構
            </option>
            <option value="horizontal_group">
              ↔️ 橫向 (關鍵字分組) - 適用一般報表
            </option>
            <option value="horizontal">↔️ 橫向 (手動指定) - 設定 A±B=C</option>
            <option value="vertical_row">
              ↕️ 縱向 (手動指定) - 設定 A±B=C
            </option>
          </select>
          <button id="btnModeHelp" class="btn btn-ghost btn-icon-sm" title="查看模式說明">
            ❓
          </button>
        </div>

        <!-- 配置 Toggle -->
        <div class="toolbar-group">
          <button
            id="btnRangeConfig"
            class="btn btn-outline btn-toggle"
            title="設定資料讀取的範圍"
          >
            <span>📐</span> 設定範圍
          </button>
          <button
            id="btnLogicConfig"
            class="btn btn-outline btn-toggle"
            title="設定關鍵字與加總邏輯"
          >
            <span>🔑</span> 設定邏輯
          </button>
        </div>

        <!-- 右側：執行操作 -->
        <div class="toolbar-group toolbar-actions">
          <button id="btnValidate" class="btn btn-success" title="開始執行驗算">
            <span>✓</span> 執行驗算
          </button>
          <button id="btnDownload" class="btn btn-danger" title="下載錯誤報告">
            <span>📑</span> 下載報告
          </button>
          <button id="btnReset" class="btn btn-outline" title="重置所有設定">
            <span>↺</span> 重置
          </button>
        </div>
      </div>

      <!-- 模式說明面板 -->
      <div id="modeHelpPanel" class="mode-help-panel hidden">
        <div class="mode-help-header">
          <h3>📖 驗算模式說明</h3>
          <button id="btnCloseModeHelp" class="btn btn-ghost btn-icon-sm">✕</button>
        </div>
        <div class="mode-help-content">
          <div class="mode-grid">
            <!-- 縱向關鍵字分組 -->
            <div class="mode-card" data-mode="vertical_group">
              <div class="mode-card-icon">↕️</div>
              <div class="mode-card-title">縱向 (關鍵字分組)</div>
              <div class="mode-card-desc">適用於預算表、財務報表</div>
              <table class="mode-example">
                <tr><td class="example-key">主管一</td><td class="example-sum">300</td></tr>
                <tr><td>　項目 A</td><td>100</td></tr>
                <tr><td>　項目 B</td><td>200</td></tr>
                <tr><td class="example-key">主管二</td><td class="example-sum">150</td></tr>
                <tr><td>　項目 C</td><td>150</td></tr>
              </table>
            </div>
            <!-- 縱向縮排分層 -->
            <div class="mode-card" data-mode="vertical_indent">
              <div class="mode-card-icon">📊</div>
              <div class="mode-card-title">縱向 (縮排分層)</div>
              <div class="mode-card-desc">適用於有階層結構的表格</div>
              <table class="mode-example">
                <tr><td class="example-sum">總計</td><td class="example-sum">600</td></tr>
                <tr><td>　類別一</td><td>350</td></tr>
                <tr><td>　　子項 A</td><td>200</td></tr>
                <tr><td>　　子項 B</td><td>150</td></tr>
                <tr><td>　類別二</td><td>250</td></tr>
              </table>
            </div>
            <!-- 橫向關鍵字分組 -->
            <div class="mode-card" data-mode="horizontal_group">
              <div class="mode-card-icon">↔️</div>
              <div class="mode-card-title">橫向 (關鍵字分組)</div>
              <div class="mode-card-desc">適用於一般報表、橫向加總</div>
              <table class="mode-example">
                <tr><th>項目</th><th>Q1</th><th>Q2</th><th class="example-key">小計</th></tr>
                <tr><td>營收</td><td>100</td><td>200</td><td class="example-sum">300</td></tr>
                <tr><td>成本</td><td>50</td><td>80</td><td class="example-sum">130</td></tr>
              </table>
            </div>
            <!-- 橫向手動指定 -->
            <div class="mode-card" data-mode="horizontal">
              <div class="mode-card-icon">↔️</div>
              <div class="mode-card-title">橫向 (手動指定)</div>
              <div class="mode-card-desc">手動選取欄位設定 A±B=C</div>
              <table class="mode-example">
                <tr><th>項目</th><th class="example-a">A</th><th class="example-b">B</th><th class="example-c">=C</th></tr>
                <tr><td>收入</td><td class="example-a">500</td><td class="example-b">200</td><td class="example-c">700</td></tr>
                <tr><td>支出</td><td class="example-a">300</td><td class="example-b">100</td><td class="example-c">400</td></tr>
              </table>
            </div>
            <!-- 縱向手動指定 -->
            <div class="mode-card" data-mode="vertical_row">
              <div class="mode-card-icon">↕️</div>
              <div class="mode-card-title">縱向 (手動指定)</div>
              <div class="mode-card-desc">手動選取列設定 A±B=C</div>
              <table class="mode-example">
                <tr><th>月份</th><th>金額</th></tr>
                <tr class="example-a"><td>1月</td><td>100</td></tr>
                <tr class="example-b"><td>2月</td><td>200</td></tr>
                <tr class="example-c"><td>=合計</td><td>300</td></tr>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- 配置面板：範圍設定 -->
      <div id="rangeConfigPanel" class="config-panel hidden">
        <div class="config-row">
          <div class="input-group">
            <label class="input-label">標題列號</label>
            <input
              type="number"
              id="headerRow"
              class="input"
              value="1"
              min="1"
              style="width: 80px"
            />
          </div>
          <div class="input-group">
            <label class="input-label">結束列號 (自動=空)</label>
            <input
              type="number"
              id="endRow"
              class="input"
              placeholder="自動"
              min="1"
              style="width: 80px"
            />
          </div>
          <div class="input-group">
            <label class="input-label">起始欄</label>
            <input
              type="number"
              id="startCol"
              class="input"
              value="1"
              min="1"
              style="width: 80px"
            />
          </div>
          <div class="input-group">
            <label class="input-label">結束欄 (自動=空)</label>
            <input
              type="number"
              id="endCol"
              class="input"
              placeholder="自動"
              min="1"
              style="width: 80px"
            />
          </div>
        </div>
      </div>

      <!-- 配置面板：邏輯設定 -->
      <div id="logicConfigPanel" class="config-panel hidden">
        <div class="config-row">
          <div class="input-group" style="flex: 1">
            <label class="input-label">關鍵字 1 (觸發結算)</label>
            <input
              type="text"
              id="keyword1"
              class="input"
              value="主管, 小計, 核定"
              placeholder="以逗號分隔"
            />
          </div>
          <div class="input-group" style="flex: 1">
            <label class="input-label">關鍵字 2 (排除忽略)</label>
            <input
              type="text"
              id="keyword2"
              class="input"
              value="合計, 總計"
              placeholder="以逗號分隔"
            />
          </div>
          <div class="input-group" id="sumDirectionGroup">
            <label class="input-label">加總位置 (重要!)</label>
            <select id="sumDirection" class="select">
              <option value="top">⬆️ 加總在上方 (歸戶式)</option>
              <option value="bottom">⬇️ 加總在下方 (會計式)</option>
            </select>
          </div>
        </div>
      </div>

      <!-- 智能偵測提示 -->
      <div id="smartDetectPanel" class="smart-detect-bar hidden">
        <span class="smart-detect-icon">🤖</span>
        <span class="smart-detect-text">智能推薦：</span>
        <span id="smartDetectResult" class="smart-detect-result"></span>
        <button id="btnApplyRecommend" class="btn btn-sm btn-primary">
          套用
        </button>
      </div>

      <!-- Main Content -->
      <main class="main-content">
        <!-- 拖曳上傳區 (檔案未載入時顯示) -->
        <div id="dropzone" class="upload-dropzone">
          <div class="upload-icon">📂</div>
          <div class="upload-title">拖曳 Excel 檔案至此處</div>
          <div class="upload-hint">
            或點擊「載入 Excel」按鈕選取檔案（支援 .xlsx, .xls）
          </div>
        </div>

        <!-- 資料表格 (檔案載入後顯示) -->
        <div id="gridContainer" class="grid-container hidden">
          <div class="grid-placeholder">
            <div class="grid-placeholder-icon">📂</div>
            <div>請先載入 Excel 檔案</div>
          </div>
        </div>

        <!-- 操作提示 (手動模式時顯示) -->
        <div id="logicHint" class="logic-hint hidden">
          <span class="hint-icon">💡</span>
          <span id="logicHintText">請點選欄位以設定驗算邏輯 (A + B = C)</span>
        </div>
      </main>

      <!-- Error Panel (Floating) -->
      <div id="errorPanel" class="error-panel hidden">
        <div class="error-panel-header">
          <span class="error-panel-icon">⚠️</span>
          <span class="error-panel-title"
            >發現 <strong id="errorCount">0</strong> 個錯誤</span
          >
        </div>
        <div class="error-panel-body">
          <div class="error-stat">
            <span class="error-stat-label">差異總額</span>
            <span class="error-stat-value" id="errorDiff">0</span>
          </div>
          <div class="error-nav">
            <button id="btnPrevError" class="btn btn-outline btn-sm">
              ← 上一個
            </button>
            <button id="btnNextError" class="btn btn-outline btn-sm">
              下一個 →
            </button>
          </div>
        </div>
      </div>

      <!-- Drop Overlay -->
      <div id="dropOverlay" class="drop-overlay">
        <div class="drop-overlay-icon">📂</div>
        <div class="drop-overlay-text">放開滑鼠以載入檔案</div>
      </div>

      <!-- Loading Overlay -->
      <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-spinner"></div>
        <div class="loading-text">處理中...</div>
      </div>

      <!-- Toast Container -->
      <div
        id="toastContainer"
        style="position: fixed; top: 20px; right: 20px; z-index: 1000"
      ></div>
    </div>

    <!-- JavaScript Modules -->
    <script src="js/smart-detect.js"></script>
    <script src="js/excel-parser.js"></script>
    <script src="js/validator.js"></script>
    <script src="js/store.js"></script>
    <script src="js/upload-component.js"></script>
    <script src="js/smart-detection-enhanced.js"></script>
    <script src="js/config-manager.js"></script>
    <script src="js/history-manager.js"></script>
    <script src="js/export-manager.js"></script>
    <script src="js/error-visualization.js"></script>
    <script src="js/table-preview.js"></script>
    <script src="js/ui-controller.js"></script>
    <script src="js/app.js"></script>
    <script src="js/report.js"></script>
  </body>
</html>
